<style>
  /* --- DASHBOARD SPECIFIC CSS --- */
  
  /* Grid Layout for Stats Cards */
  .dash-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
  }

  /* Stat Cards */
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #eee;
  }
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  .stat-card h3 {
    margin: 0;
    font-size: 2rem;
    color: #333;
    font-weight: 700;
  }
  .stat-card p {
    margin: 5px 0 0;
    color: #666;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Color accents for cards */
  .st-blue { border-bottom: 5px solid #007bff; }
  .st-green { border-bottom: 5px solid #28a745; }
  .st-orange { border-bottom: 5px solid #fd7e14; }
  .st-red { border-bottom: 5px solid #dc3545; }

  /* Chart Container */
  .chart-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    border: 1px solid #eee;
    position: relative;
    height: 300px; /* Fixed height for chart stability */
    width: 100%;
  }

  /* Recent Activity Table */
  .table-responsive {
    overflow-x: auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eee;
  }

  .recent-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 500px; /* Ensures table doesn't squish on mobile */
  }

  .recent-table th, .recent-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #f1f1f1;
    font-size: 0.9rem;
  }

  .recent-table th {
    background-color: #f8f9fa;
    color: #555;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
  }
  
  .recent-table tr:last-child td {
    border-bottom: none;
  }

  /* Badges */
  .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
  .bg-ver { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .bg-dis { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  
  /* Dashboard Header */
  .dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #eee;
    padding-bottom: 15px;
  }
  
  .dash-header h2 {
    margin: 0;
    color: #0056b3;
    font-size: 1.5rem;
    border: none;
    padding: 0;
  }
</style>

<div id="dashboardView" style="display:none;">
    
    <div class="dash-header">
        <h2>ðŸ“Š Executive Dashboard</h2>
        <button onclick="closeDashboard()" style="width:auto; background:#6c757d; padding: 10px 20px; font-size: 0.9rem;">&larr; Back to Panel</button>
    </div>

    <div class="dash-grid">
        <div class="stat-card st-blue">
            <h3 id="d_total">0</h3>
            <p>Total Assets</p>
        </div>
        <div class="stat-card st-green">
            <h3 id="d_verified">0</h3>
            <p>Verified</p>
        </div>
        <div class="stat-card st-orange">
            <h3 id="d_pending">0</h3>
            <p>Pending</p>
        </div>
        <div class="stat-card st-red">
            <h3 id="d_disputed">0</h3>
            <p>Disputed</p>
        </div>
    </div>

    <div class="chart-container">
        <h4 style="margin-top:0; color:#333; margin-bottom: 15px;">Asset Type Distribution</h4>
        <div style="height: 240px; width: 100%;">
            <canvas id="assetTypeChart"></canvas>
        </div>
    </div>

    <h4 style="margin-bottom: 15px; color:#333;">Recent Activity Log ðŸ•’</h4>
    <div class="table-responsive">
        <table class="recent-table">
            <thead>
                <tr>
                    <th>Asset ID</th>
                    <th>Employee</th>
                    <th>Status</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="recentActivityBody">
                <tr><td colspan="4" style="text-align:center; color:#999;">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div style="height: 50px;"></div> </div>

<script>
/* --- DASHBOARD JAVASCRIPT LOGIC --- */

let dashboardChart = null; // Variable to hold the chart instance

// Function to Open Dashboard
async function openDashboard() {
  // 1. Hide the Main Phase 3 View
  document.getElementById('phase3').style.display = 'none';
  
  // 2. Show the Dashboard View
  document.getElementById('dashboardView').style.display = 'block';
  
  // 3. Show Loading Spinner
  showLoading(true, "Gathering Insights...", "Fetching live data from sheets...", "spinner");

  // 4. Fetch Data from Backend (dashboard.gs)
  const response = await apiCall('getDashboardData');
  
  // 5. Hide Loading
  showLoading(false);

  // 6. Render Data
  if(response.success) {
    renderDashboardUI(response.data);
  } else {
    alert("Error loading dashboard: " + response.message);
    closeDashboard(); // Go back if error
  }
}

// Function to Close Dashboard
function closeDashboard() {
  document.getElementById('dashboardView').style.display = 'none';
  document.getElementById('phase3').style.display = 'block';
}

// Function to Render Data onto UI
function renderDashboardUI(data) {
  // A. Update Number Cards
  animateValue("d_total", 0, data.total, 1000);
  animateValue("d_verified", 0, data.verified, 1000);
  animateValue("d_pending", 0, data.pending, 1000);
  animateValue("d_disputed", 0, data.disputed, 1000);

  // B. Render Table
  const tbody = document.getElementById('recentActivityBody');
  tbody.innerHTML = '';
  
  if (data.recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No recent activity found.</td></tr>';
  } else {
      data.recent.forEach(item => {
        let badgeClass = item.status.toLowerCase() === 'verified' ? 'bg-ver' : 'bg-dis';
        // Truncate user name if too long
        let shortUser = item.user.length > 15 ? item.user.substring(0, 15) + '...' : item.user;
        
        let row = `<tr>
            <td><strong>${item.assetId}</strong></td>
            <td>${shortUser}</td>
            <td><span class="badge ${badgeClass}">${item.status}</span></td>
            <td>${item.date}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
  }

  // C. Render Chart
  renderChart(data.types);
}

// Helper: Render Chart.js Chart
function renderChart(typeData) {
    const ctx = document.getElementById('assetTypeChart').getContext('2d');
    
    // Destroy previous chart if exists to avoid "glitch" or overlap
    if (dashboardChart) {
        dashboardChart.destroy();
    }

    const labels = Object.keys(typeData);
    const values = Object.values(typeData);
    
    // Generate simple colors dynamically
    const colors = values.map(() => `hsl(${Math.random() * 360}, 70%, 50%)`);

    dashboardChart = new Chart(ctx, {
        type: 'bar', // Change to 'doughnut' or 'pie' if you prefer
        data: {
            labels: labels,
            datasets: [{
                label: 'Asset Count',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    ticks: { stepSize: 1 } 
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
}

// Helper: Number Counting Animation
function animateValue(id, start, end, duration) {
    if (start === end) return;
    const range = end - start;
    let current = start;
    const increment = end > start ? 1 : -1;
    const stepTime = Math.abs(Math.floor(duration / range));
    const obj = document.getElementById(id);
    const timer = setInterval(function() {
        current += increment;
        obj.innerHTML = current;
        if (current == end) {
            clearInterval(timer);
        }
    }, stepTime);
}
</script>
