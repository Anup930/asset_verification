<!-- V 2.1.5 -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asset Verification App</title>
    <style>
      /* --- RESET & BASIC STYLING --- */
      * { box-sizing: border-box; }
      
      body { 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
          background-color: #f4f4f9; 
          margin: 0; 
          padding: 10px; 
          color: #333; 
          -webkit-font-smoothing: antialiased;
      }

      /* Responsive Container */
      .container { 
          width: 100%; 
          max-width: 800px; 
          margin: 0 auto; 
          background: #fff; 
          padding: 20px; 
          border-radius: 8px; 
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
      }

      h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; font-size: 1.5rem; }
      h4 { color: #0056b3; margin-top: 25px; margin-bottom: 10px; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 5px;}

      /* --- FORM ELEMENTS --- */
      input[type="text"], input[type="email"], select, input[type="file"] { 
          width: 100%; 
          padding: 12px; 
          margin: 8px 0 15px 0; 
          border: 1px solid #ccc; 
          border-radius: 6px; 
          font-size: 16px; 
          background: #fff;
      }
      
      /* File Input Styling */
      input[type="file"] {
          padding: 10px;
          background: #f8f9fa;
          border: 1px dashed #ced4da;
      }

      /* --- BUTTONS --- */
      button { 
          background-color: #007bff; 
          color: white; 
          padding: 12px 20px; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          font-size: 16px; 
          font-weight: 500;
          margin-top: 5px; 
          width: 100%; 
          transition: background-color 0.2s; 
      }
      button:active { transform: scale(0.98); }
      button:hover { background-color: #0056b3; }
      
      button.add-btn { background-color: #28a745; margin-bottom: 10px; }
      button.add-btn:hover { background-color: #1e7e34; }
      
      button.cancel-btn { background-color: #6c757d; margin-top: 10px; }
      button.cancel-btn:hover { background-color: #5a6268; }

      button.dispute-btn { background-color: #dc3545; margin-top: 8px; }
      
      /* Admin Specific Buttons */
      button.admin-btn { background-color: #6f42c1; }
      
      /* --- UTILS --- */
      .error { color: #dc3545; margin-top: 10px; font-weight: 500; text-align: center;}
      .success { color: #28a745; margin-top: 10px; font-weight: 500; text-align: center;}
      
      /* --- CARDS (ASSET LIST) --- */
      .card { 
          border: 1px solid #e9ecef; 
          padding: 15px; 
          margin-bottom: 15px; 
          border-radius: 8px; 
          background-color: #fff; 
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .card p { margin: 8px 0; line-height: 1.4; }
      .verified-card { background-color: #f0fff4; border-left: 5px solid #28a745; }
      
      /* --- ADMIN BANNER --- */
      .admin-banner {
        background-color: #fff3cd;
        color: #856404;
        padding: 15px;
        text-align: center;
        border: 1px solid #ffeeba;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      /* --- HEADER FLEX (User Info) --- */
      .header-flex {
          display: flex;
          flex-direction: column; 
          align-items: center;
          gap: 10px;
          text-align: center;
          margin-bottom: 20px;
      }

      /* --- MODALS --- */
      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .modal-content { 
          background: #fff; 
          margin: 10% auto; 
          padding: 25px; 
          width: 90%; 
          max-width: 500px; 
          border-radius: 12px; 
          position: relative; 
          box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      }
      
      /* --- LOADING OVERLAY & ANIMATION --- */
      #loadingOverlay { 
          display:none; 
          position: fixed; 
          top:0; left:0; 
          width:100%; height:100%; 
          background:rgba(255,255,255,0.95); 
          z-index:2000; 
          text-align: center; 
          padding-top: 40vh; 
          margin-top: -40px;
          font-size: 1.2rem; 
          font-weight: bold; 
          color: #007bff; 
          transition: all 0.3s ease;
      }

      /* Spinner Animation */
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-text {
        padding: 0 20px;
        line-height: 1.6;
      }

      .loading-subtext {
        display: block;
        margin-top: 10px;
        font-size: 14px; 
        color: #666; 
        font-weight: normal;
      }

      /* --- MEDIA QUERIES (TABLET & DESKTOP) --- */
      @media (min-width: 600px) {
          .container { padding: 40px; margin-top: 30px; }
          .header-flex { flex-direction: row; justify-content: space-between; text-align: left; }
          button { width: auto; min-width: 120px; }
          button.admin-btn { width: 100%; }
          .card-actions { display: flex; gap: 10px; }
          .card-actions button { flex: 1; }
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" class="loading-text">Processing...</div>
        <span id="loadingSubText" class="loading-subtext">Please wait</span>
    </div>

    <div class="container">
      <h2>Asset Verification</h2>

      <div id="phase1">
        <p style="text-align: center; color: #666;">Enter your Employee ID</p>
        <input type="text" id="empIdInput" placeholder="e.g. EMP123" required>
        <button onclick="handleEmpIdCheck()">Check ID</button>
        <div id="p1_message" class="error"></div>
      </div>

      <!-- <div id="phase2" style="display:none;">
        <div class="card">
            <h4 style="margin-top:0;">Confirm Details</h4>
            <p><strong>Name:</strong> <span id="confirm_name"></span></p>
            <p><strong>Email:</strong> <span id="confirm_email"></span></p>
        </div>
        
        <button onclick="handleSendCode()">Yes, send me Code</button>
        <button class="cancel-btn" onclick="showPhase(1)">Back</button>
        <div id="p2_message" class="error"></div>
        
        <div id="otp_section" style="display:none; margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;">
            <p style="text-align: center;">Enter 6-digit OTP sent to email</p>
            <input type="text" id="otpInput" placeholder="000000" style="text-align: center; letter-spacing: 5px; font-size: 20px;" inputmode="numeric" pattern="[0-9]*">
            <button onclick="handleOtpVerification()">Verify & Login</button>
            <div id="otp_message" class="error"></div>
        </div>
      </div> -->

      <div id="phase2" style="display:none;">
        <div class="card">
            <h4 style="margin-top:0;">Confirm Details</h4>
            <p><strong>Name:</strong> <span id="confirm_name"></span></p>
            <p><strong>Email:</strong> <span id="confirm_email"></span></p>
        </div>
        
        <button id="sendCodeBtn" onclick="handleSendCode()">Yes, send me Code</button>
        <p id="timer_display" style="text-align: center; font-size: 14px; color: #dc3545; display: none; margin-top: 5px;"></p>
        
        <button class="cancel-btn" onclick="showPhase(1)">Back</button>
        <div id="p2_message" class="error"></div>
        
        <div id="otp_section" style="display:none; margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;">
            <p style="text-align: center;">Enter 6-digit OTP sent to email</p>
            <input type="text" id="otpInput" placeholder="000000" style="text-align: center; letter-spacing: 5px; font-size: 20px;" inputmode="numeric" pattern="[0-9]*">
            <button onclick="handleOtpVerification()">Verify & Login</button>
            <div id="otp_message" class="error"></div>
        </div>
      </div>

      <div id="phase3" style="display:none;">
        
        <div id="adminActingBanner" class="admin-banner">
            ‚ö†Ô∏è <strong>ADMIN MODE</strong><br>
            Managing: <strong id="acting_for_name"></strong> (<span id="acting_for_id"></span>)
            <br>
            <button style="background-color: #333; color: #fff; padding: 8px; margin-top: 10px; width: auto;" onclick="exitAdminMode()">Exit / Return to My Profile</button>
        </div>

        <div class="header-flex">
            <div>
                <div style="font-size: 1.1rem; font-weight: bold;">Hi, <span id="user_name_display"></span></div>
                <div style="font-size: 0.9rem; color: #666;">Role: <span id="user_type_display"></span></div>
            </div>
            <button onclick="logout()" style="background-color: #6c757d; font-size: 14px;">Logout</button>
        </div>

        <div id="adminPanel" style="display:none; border: 2px dashed #6f42c1; padding: 15px; margin: 15px 0; border-radius: 8px; background-color: #f3e5f5;">
            <h4 style="color: #6f42c1; border-bottom: none; margin-top: 0;">Admin Tools</h4>
            <button class="admin-btn" onclick="openAdminSearchModal()">üîç Manage Another Employee</button>
        </div>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <div style="text-align: center; margin-bottom: 20px;">
            <button class="add-btn" style="width: 100%; max-width: 300px;" onclick="openAddNewAssetModal()">‚ûï Add New Asset</button>
        </div>

        <h4>Pending Action ‚ö†Ô∏è</h4>
        <div id="pendingAssetContainer" class="asset-list"></div>

        <h4 style="margin-top: 30px;">Verified History ‚úÖ</h4>
        <div id="verifiedAssetContainer" class="asset-list"></div>
      </div>

    </div>

    <!-- <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h4 style="margin-top:0;">Verify Asset</h4>
            <p style="background: #e9ecef; padding: 10px; border-radius: 4px;"><strong>ID:</strong> <span id="asset_to_verify"></span></p>
            
            <p style="font-size: 0.9rem; color: #555;">üì∏ <strong>Camera:</strong> Tapping below will open your camera.</p>

            <label>Front Photo:</label>
            <input type="file" id="frontPic" accept="image/*" capture="environment" required>
            
            <label>Back Photo (Serial No):</label>
            <input type="file" id="backPic" accept="image/*" capture="environment" required>
            
            <button onclick="submitVerification()">Submit Verification</button>
            <button class="cancel-btn" onclick="closeModal('verificationModal')">Cancel</button>
            <div id="verification_message" class="error"></div>
        </div>
    </div> -->

    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h4 style="margin-top:0;">Verify Asset</h4>
            <p style="background: #e9ecef; padding: 10px; border-radius: 4px;"><strong>ID:</strong> <span id="asset_to_verify"></span></p>
            
            <p style="font-size: 0.9rem; color: #555; margin-bottom: 20px;">üì∏ <strong>Camera:</strong> Tapping below will open your camera.</p>

            <label>Front Photo:</label>
            <div style="background-color: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; font-size: 0.85rem; margin-bottom: 8px; border-left: 4px solid #ffeeba;">
               ‚ö†Ô∏è <strong>Note:</strong> Serial Number must be clearly visible on the screen/device.
            </div>
            <input type="file" id="frontPic" accept="image/*" capture="environment" required>
            
            <label style="margin-top: 15px; display:block;">Back Photo (Sticker):</label>
             <div style="background-color: #d1ecf1; color: #0c5460; padding: 8px; border-radius: 4px; font-size: 0.85rem; margin-bottom: 8px; border-left: 4px solid #bee5eb;">
               ‚ÑπÔ∏è <strong>Note:</strong> The Company Sticker/Label must be clearly visible.
            </div>
            <input type="file" id="backPic" accept="image/*" capture="environment" required>
            
            <button onclick="submitVerification()" style="margin-top: 20px;">Submit Verification</button>
            <button class="cancel-btn" onclick="closeModal('verificationModal')">Cancel</button>
            <div id="verification_message" class="error"></div>
        </div>
    </div>

    <div id="disputeModal" class="modal">
        <div class="modal-content">
            <h4 style="margin-top:0;">Dispute Asset</h4>
            <p>ID: <span id="asset_to_dispute"></span></p>
            
            <label>Reason:</label>
            <select id="disputeReason">
                <option value="I don't know about this asset">I don't know about this asset</option>
                <option value="Submitted to IT">Submitted to IT</option>
                <option value="Missing/Lost">Missing/Lost</option>
                <option value="Other">Other (Specify below)</option>
            </select>
            
            <input type="text" id="disputeRemark" placeholder="Remarks (Optional)">
            
            <button class="dispute-btn" onclick="submitDispute()">Submit Dispute</button>
            <button class="cancel-btn" onclick="closeModal('disputeModal')">Cancel</button>
            <div id="dispute_message" class="error"></div>
        </div>
    </div>
    
    <div id="addNewAssetModal" class="modal">
        <div class="modal-content">
            <h4 style="margin-top:0;">Add New Asset</h4>
            
            <label>Type:</label>
            <input type="text" id="newAssetType" placeholder="e.g. Monitor, Mouse">
            
            <label>Serial Number:</label>
            <input type="text" id="newAssetSerialNo" placeholder="S/N found on sticker">
            
            <label>Company:</label>
            <input type="text" id="newAssetCompany" placeholder="e.g. Dell">
            
            <label>Front Photo:</label>
            <input type="file" id="newAssetFrontPic" accept="image/*" capture="environment">
            
            <label>Back Photo:</label>
            <input type="file" id="newAssetBackPic" accept="image/*" capture="environment">
            
            <button class="add-btn" onclick="submitNewAsset()">Submit</button>
            <button class="cancel-btn" onclick="closeModal('addNewAssetModal')">Cancel</button>
            <div id="new_asset_message" class="error"></div>
        </div>
    </div>

    <div id="adminSearchModal" class="modal">
        <div class="modal-content">
            <h4 style="margin-top:0;">Find Employee</h4>
            
            <div id="admin_step1">
                <input type="text" id="adminTargetEmpId" placeholder="Enter Target Emp ID">
                <button onclick="adminCheckTargetEmp()">Search</button>
            </div>
            
            <div id="admin_step2" style="display:none;">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                    <p style="margin:5px 0;"><strong>Found:</strong> <span id="admin_target_name"></span></p>
                    <p style="margin:5px 0; font-size: 0.9rem;"><strong>Email:</strong> <span id="admin_target_email"></span></p>
                </div>
                <button onclick="adminSendOtp()">Send OTP to Employee</button>
            </div>
            
            <div id="admin_step3" style="display:none;">
                <p>Ask employee for the OTP sent to their email:</p>
                <input type="text" id="adminTargetOtp" placeholder="6-digit OTP" inputmode="numeric" pattern="[0-9]*">
                <button onclick="adminVerifyTargetOtp()">Verify & Access</button>
            </div>
            
            <div id="admin_msg" class="error"></div>
            <button class="cancel-btn" onclick="closeModal('adminSearchModal')">Cancel</button>
        </div>
    </div>

    <script>
      // !!! PASTE YOUR APPS SCRIPT WEB APP URL HERE !!!
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCIkOqC779qpxzcGaqXzo1FkNjf2jCBezepMrUvuaARkfURJQjBIerPk0F49RqQ9xU/exec";

      /* --- GLOBAL VARS --- */
      let loggedInEmpId = '';
      let loggedInUserName = '';
      let loggedInUserRole = '';
      let currentEmpId = '';
      let targetEmpData = null;
      let currentAssetToVerify = null;
      let currentAssetToDispute = null;

      /* --- API HELPER & ANIMATION LOGIC --- */
      
      // Updated function to show/hide loader with specific text
      function showLoading(show, mainText = "Processing...", subText = "") {
          const overlay = document.getElementById('loadingOverlay');
          const txtDiv = document.getElementById('loadingText');
          const subTxtDiv = document.getElementById('loadingSubText');
          
          if(show) {
              txtDiv.innerHTML = mainText;
              subTxtDiv.innerHTML = subText;
              overlay.style.display = 'block';
          } else {
              overlay.style.display = 'none';
          }
      }

      // Helper to update text while loading is already open
      function updateLoadingText(mainText, subText = "") {
        document.getElementById('loadingText').innerHTML = mainText;
        document.getElementById('loadingSubText').innerHTML = subText;
      }

      async function apiCall(action, payload = {}) {
        // Note: We don't call showLoading here automatically anymore 
        // because we want custom messages for each button.
        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: action, ...payload })
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error("API Error:", error);
            return { success: false, message: "Connection Error. Check internet." };
        }
      }

      /* --- NAVIGATION --- */
      function showPhase(phase) {
        document.getElementById('phase1').style.display = 'none';
        document.getElementById('phase2').style.display = 'none';
        document.getElementById('phase3').style.display = 'none';
        if (phase === 1) document.getElementById('phase1').style.display = 'block';
        if (phase === 2) document.getElementById('phase2').style.display = 'block';
        if (phase === 3) document.getElementById('phase3').style.display = 'block';
      }

      /* --- LOGIC: LOGIN (WITH STORYTELLING) --- */
      async function handleEmpIdCheck() {
        const empId = document.getElementById('empIdInput').value.trim();
        const msgDiv = document.getElementById('p1_message');
        msgDiv.textContent = '';
        
        if (!empId) { msgDiv.textContent = 'Enter ID'; return; }

        // --- STORYTELLING ANIMATION START ---
        
        // Step 1: Sending request
        showLoading(true, "We have Sent you ID to Gretex DB...", "Please wait...");
        
        // Artificial delay for effect (1 second)
        await new Promise(r => setTimeout(r, 1000));

        // Step 2: Reading DB
        updateLoadingText("We are reading your data in DB...", "Searching records...");
        
        // Actual API Call
        const response = await apiCall('checkEmpId', { empId: empId });
        
        if (response.success) {
            // Step 3: Success Message
            updateLoadingText("Congratulations! We have found your Detail in DB.", "Redirecting to confirmation...");
            
            // Wait 1.5 seconds so user can read the success message
            await new Promise(r => setTimeout(r, 1500));
            
            showLoading(false); // Hide Loader
            
            loggedInEmpId = response.empId;
            loggedInUserName = response.name;
            document.getElementById('confirm_name').textContent = response.name;
            document.getElementById('confirm_email').textContent = response.email;
            showPhase(2);
        } else {
            // Step 3: Failure Message
            updateLoadingText("Oh oh, we have not found any data related to your Emp ID.", "Make sure you are a Gretex Employee.<br>Kindly connect to IT Team.");
            
            // Wait 3 seconds so user can read the error
            await new Promise(r => setTimeout(r, 3000));
            
            showLoading(false); // Hide Loader
            msgDiv.textContent = response.message;
        }
      }

      // async function handleSendCode() {
      //   const email = document.getElementById('confirm_email').textContent;
      //   const msgDiv = document.getElementById('p2_message');
        
      //   showLoading(true, "Sending Verification Code...", "Please check your email shortly.");
        
      //   const response = await apiCall('sendVerificationCode', { email: email, empId: loggedInEmpId });
      //   showLoading(false);

      //   if(response.success) {
      //       msgDiv.textContent = 'Code sent to email!';
      //       msgDiv.className = 'success';
      //       document.getElementById('otp_section').style.display = 'block';
      //   } else {
      //       msgDiv.textContent = response.message;
      //   }
      // }

      /* --- TIMER VARIABLE --- */
      
      let countdownInterval;

      /* --- UPDATED LOGIC: SEND CODE WITH TIMER --- */
      async function handleSendCode() {
        const email = document.getElementById('confirm_email').textContent;
        const msgDiv = document.getElementById('p2_message');
        const sendBtn = document.getElementById('sendCodeBtn'); // Make sure button has this ID
        
        showLoading(true, "Sending Verification Code...", "Please check your email shortly.");
        
        const response = await apiCall('sendVerificationCode', { email: email, empId: loggedInEmpId });
        showLoading(false);

        if(response.success) {
            msgDiv.textContent = 'Code sent to email!';
            msgDiv.className = 'success';
            document.getElementById('otp_section').style.display = 'block';
            
            // START THE TIMER (60 Seconds)
            startTimer(60, sendBtn);
            
        } else {
            msgDiv.textContent = response.message;
            msgDiv.className = 'error';
        }
      }

      /* --- NEW FUNCTION: TIMER LOGIC --- */
      function startTimer(duration, buttonElement) {
          let timer = duration;
          const display = document.getElementById('timer_display');
          
          // Disable button and show timer text
          buttonElement.disabled = true;
          buttonElement.style.backgroundColor = "#ccc"; // Grey out button
          buttonElement.style.cursor = "not-allowed";
          display.style.display = "block";
          
          clearInterval(countdownInterval); // Clear any existing timer
          
          countdownInterval = setInterval(function () {
              const minutes = parseInt(timer / 60, 10);
              const seconds = parseInt(timer % 60, 10);

              const secStr = seconds < 10 ? "0" + seconds : seconds;
              display.textContent = `Resend available in ${minutes}:${secStr}`;

              if (--timer < 0) {
                  // Timer Finished
                  clearInterval(countdownInterval);
                  display.style.display = "none";
                  buttonElement.disabled = false;
                  buttonElement.textContent = "Resend Code";
                  buttonElement.style.backgroundColor = "#007bff"; // Restore color
                  buttonElement.style.cursor = "pointer";
              }
          }, 1000);
      }
      
      async function handleOtpVerification() {
        const otp = document.getElementById('otpInput').value.trim();
        const msgDiv = document.getElementById('otp_message');
        if (!otp) { msgDiv.textContent = 'Enter OTP'; return; }
        
        showLoading(true, "Verifying OTP...", "Logging you in...");

        const response = await apiCall('verifyOtp', { empId: loggedInEmpId, otp: otp });
        
        showLoading(false);

        if (response.success) {
             loggedInUserRole = response.userType;
             currentEmpId = loggedInEmpId;
             document.getElementById('user_name_display').textContent = loggedInUserName;
             document.getElementById('user_type_display').textContent = loggedInUserRole;
             document.getElementById('adminPanel').style.display = (loggedInUserRole === 'Admin') ? 'block' : 'none';
             showPhase(3);
             loadAssets();
        } else {
             msgDiv.textContent = response.message;
        }
      }

      /* --- LOGIC: ASSETS --- */
      async function loadAssets() {
        document.getElementById('pendingAssetContainer').innerHTML = '<p style="text-align:center;">Loading...</p>';
        document.getElementById('verifiedAssetContainer').innerHTML = '<p style="text-align:center;">Loading...</p>';
        
        // Use simpler api call without blocking full screen for loading assets
        const pending = await apiCall('getPendingAssets', { empId: currentEmpId });
        renderPendingAssets(pending);

        const verified = await apiCall('getVerifiedAssets', { empId: currentEmpId });
        renderVerifiedAssets(verified);
      }

      // function renderPendingAssets(assets) {
      //   const container = document.getElementById('pendingAssetContainer');
      //   container.innerHTML = '';
      //   if (!assets || assets.length === 0) { 
      //       container.innerHTML = '<div class="card" style="text-align:center; color:#28a745;">üéâ All caught up! No pending assets.</div>'; 
      //       return; 
      //   }
      //   assets.forEach(asset => {
      //        const div = document.createElement('div');
      //        div.className = 'card';
      //        div.innerHTML = `
      //          <p><strong>${asset.AssetType}</strong></p>
      //          <p style="font-size: 0.9rem; color: #666;">ID: ${asset.AssetID} <br> Serial: ${asset.SerialNumber}</p>
      //          <div class="card-actions">
      //              <button onclick="openVerificationModal('${asset.AssetID}', ${asset.RowIndex})">Verify</button>
      //              <button class="dispute-btn" onclick="openDisputeModal('${asset.AssetID}', ${asset.RowIndex})">Dispute</button>
      //          </div>
      //        `;
      //        container.appendChild(div);
      //   });
      // }

      function renderPendingAssets(assets) {
        const container = document.getElementById('pendingAssetContainer');
        container.innerHTML = '';
        if (!assets || assets.length === 0) { 
            container.innerHTML = '<div class="card" style="text-align:center; color:#28a745;">üéâ All caught up! No pending assets.</div>'; 
            return; 
        }
        assets.forEach(asset => {
             const div = document.createElement('div');
             div.className = 'card';
             // UPDATED HTML BELOW: Added Company Name
             div.innerHTML = `
               <div style="display:flex; justify-content:space-between; align-items:center;">
                   <p style="margin:0; font-size: 1.1rem;"><strong>${asset.AssetType}</strong></p>
                   <span style="background:#e3f2fd; color:#0d47a1; padding:2px 8px; border-radius:10px; font-size:0.8rem; font-weight:bold;">${asset.Company || 'N/A'}</span>
               </div>
               <p style="font-size: 0.9rem; color: #666; margin-top:5px;">
                   ID: ${asset.AssetID} <br> 
                   Serial: ${asset.SerialNumber}
               </p>
               <div class="card-actions">
                   <button onclick="openVerificationModal('${asset.AssetID}', ${asset.RowIndex})">Verify</button>
                   <button class="dispute-btn" onclick="openDisputeModal('${asset.AssetID}', ${asset.RowIndex})">Dispute</button>
               </div>
             `;
             container.appendChild(div);
        });
      }

      
      function renderVerifiedAssets(assets) {
        const container = document.getElementById('verifiedAssetContainer');
        container.innerHTML = '';
        if (!assets || assets.length === 0) { container.innerHTML = '<p style="text-align:center; color:#666;">No verified assets found.</p>'; return; }
        assets.forEach(asset => {
             const div = document.createElement('div');
             div.className = 'card verified-card';
             div.innerHTML = `
                 <p>‚úÖ <strong>${asset.AssetType}</strong></p>
                 <p style="font-size: 0.85rem;">ID: ${asset.AssetID} <br> Serial: ${asset.SerialNumber}</p>
                 <p style="font-size: 0.85rem; color: #666;">Verified: ${asset.LastVerifiedDate}</p>
                 <div style="margin-top:5px; font-size: 0.9rem;">
                    <a href="${asset.FrontURL}" target="_blank">Front</a> | <a href="${asset.BackURL}" target="_blank">Back</a>
                 </div>
             `;
             container.appendChild(div);
        });
      }

      /* --- LOGIC: MODALS & FORMS --- */
      function openVerificationModal(id, idx) {
        currentAssetToVerify = { id: id, rowIndex: idx };
        document.getElementById('asset_to_verify').textContent = id;
        document.getElementById('frontPic').value = ''; // Reset files
        document.getElementById('backPic').value = '';
        document.getElementById('verificationModal').style.display = 'block';
      }
      
      function openDisputeModal(id, idx) {
        currentAssetToDispute = { id: id, rowIndex: idx };
        document.getElementById('asset_to_dispute').textContent = id;
        document.getElementById('disputeModal').style.display = 'block';
      }

      function openAddNewAssetModal() { 
          document.getElementById('newAssetType').value = '';
          document.getElementById('newAssetSerialNo').value = '';
          document.getElementById('newAssetCompany').value = '';
          document.getElementById('newAssetFrontPic').value = '';
          document.getElementById('newAssetBackPic').value = '';
          document.getElementById('addNewAssetModal').style.display = 'block'; 
      }
      
      function closeModal(id) { document.getElementById(id).style.display = 'none'; }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          if (!file) resolve(null);
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      /* --- LOGIC: SUBMISSIONS --- */
      async function submitVerification() {
        const f = document.getElementById('frontPic').files[0];
        const b = document.getElementById('backPic').files[0];
        const msg = document.getElementById('verification_message');
        msg.textContent = '';
        
        if(!f || !b) { msg.textContent = 'Please attach both photos.'; return; }
        
        // Show specific loading message
        showLoading(true, "Uploading Photos...", "This may take a moment depending on internet speed.");

        try {
            const fD = await fileToBase64(f);
            const bD = await fileToBase64(b);
            const res = await apiCall('verifyAsset', { 
                assetId: currentAssetToVerify.id, 
                rowIndex: currentAssetToVerify.rowIndex, 
                frontPic: fD, 
                backPic: bD 
            });
            
            showLoading(false);

            if(res.success) {
                alert("Success: " + res.message);
                closeModal('verificationModal');
                loadAssets();
            } else {
                msg.textContent = res.message;
            }
        } catch(e) { 
            showLoading(false);
            msg.textContent = "Error processing images."; 
        }
      }

      async function submitDispute() {
        const r = document.getElementById('disputeReason').value;
        const rem = document.getElementById('disputeRemark').value;
        
        showLoading(true, "Submitting Dispute...", "Updating records...");

        const res = await apiCall('disputeAsset', { 
            rowIndex: currentAssetToDispute.rowIndex, 
            reason: r, 
            remark: rem 
        });
        
        showLoading(false);

        if(res.success) {
            alert(res.message);
            closeModal('disputeModal');
            loadAssets();
        } else {
            document.getElementById('dispute_message').textContent = res.message;
        }
      }

      async function submitNewAsset() {
        const t = document.getElementById('newAssetType').value;
        const s = document.getElementById('newAssetSerialNo').value;
        const c = document.getElementById('newAssetCompany').value;
        const f = document.getElementById('newAssetFrontPic').files[0];
        const b = document.getElementById('newAssetBackPic').files[0];
        const msg = document.getElementById('new_asset_message');
        msg.textContent = '';

        if(!t || !s || !c || !f || !b) { msg.textContent = 'All fields and photos are required.'; return; }
        
        showLoading(true, "Adding New Asset...", "Uploading photos and creating records...");

        try {
            const fD = await fileToBase64(f);
            const bD = await fileToBase64(b);
            const res = await apiCall('addNewAsset', {
                empId: currentEmpId,
                assetType: t,
                serialNumber: s,
                company: c,
                frontPic: fD,
                backPic: bD
            });
            
            showLoading(false);

            if(res.success) {
                alert(res.message);
                closeModal('addNewAssetModal');
                loadAssets();
            } else {
                msg.textContent = res.message;
            }
        } catch(e) { 
            showLoading(false);
            msg.textContent = e; 
        }
      }

      /* --- LOGIC: ADMIN --- */
      function openAdminSearchModal() {
          document.getElementById('adminSearchModal').style.display = 'block';
          document.getElementById('adminTargetEmpId').value = '';
          document.getElementById('admin_msg').textContent = '';
          document.getElementById('admin_step1').style.display = 'block';
          document.getElementById('admin_step2').style.display = 'none';
          document.getElementById('admin_step3').style.display = 'none';
      }

      async function adminCheckTargetEmp() {
          const targetId = document.getElementById('adminTargetEmpId').value.trim();
          const msgDiv = document.getElementById('admin_msg');
          if(!targetId) { msgDiv.textContent = "Enter ID"; return; }
          
          showLoading(true, "Searching Employee...", "Looking up ID in database...");

          const response = await apiCall('checkEmpId', { empId: targetId });
          
          showLoading(false);

          if(response.success) {
              targetEmpData = response;
              document.getElementById('admin_target_name').textContent = response.name;
              document.getElementById('admin_target_email').textContent = response.email;
              document.getElementById('admin_step1').style.display = 'none';
              document.getElementById('admin_step2').style.display = 'block';
          } else {
              msgDiv.textContent = "User not found.";
          }
      }

      async function adminSendOtp() {
          const msgDiv = document.getElementById('admin_msg');
          
          showLoading(true, "Sending OTP...", "Emailing target employee...");

          const response = await apiCall('sendVerificationCode', { email: targetEmpData.email, empId: targetEmpData.empId });
          
          showLoading(false);

          if(response.success) {
              document.getElementById('admin_step2').style.display = 'none';
              document.getElementById('admin_step3').style.display = 'block';
          } else {
              msgDiv.textContent = "Error sending OTP.";
          }
      }

      async function adminVerifyTargetOtp() {
          const otp = document.getElementById('adminTargetOtp').value.trim();
          const msgDiv = document.getElementById('admin_msg');
          
          showLoading(true, "Verifying OTP...", "Accessing employee profile...");

          const response = await apiCall('verifyOtp', { empId: targetEmpData.empId, otp: otp });
          
          showLoading(false);

          if(response.success) {
              currentEmpId = targetEmpData.empId;
              document.getElementById('adminActingBanner').style.display = 'block';
              document.getElementById('acting_for_name').textContent = targetEmpData.name;
              document.getElementById('acting_for_id').textContent = targetEmpData.empId;
              document.getElementById('adminPanel').style.display = 'none';
              closeModal('adminSearchModal');
              loadAssets();
          } else {
              msgDiv.textContent = "Invalid OTP.";
          }
      }

      function exitAdminMode() {
          currentEmpId = loggedInEmpId;
          document.getElementById('adminActingBanner').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          loadAssets();
      }

      function logout() {
          loggedInEmpId = ''; loggedInUserRole = ''; currentEmpId = '';
          location.reload(); 
      }
      
      document.addEventListener('DOMContentLoaded', () => showPhase(1));
    </script>
  </body>
</html>
